<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Game with Ads</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Monetag SDK -->
    <script type="text/javascript">
        (function() {
            var script = document.createElement('script');
            script.src = "https://s.yllix.com/yllix_web_services.js";
            script.type = "text/javascript";
            document.getElementsByTagName('head')[0].appendChild(script);
        })();
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--tg-theme-bg-color, #18222d);
            color: var(--tg-theme-text-color, #ffffff);
            text-align: center;
        }
        
        .game-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .puzzle-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin: 20px 0;
        }
        
        .puzzle-piece {
            aspect-ratio: 1;
            background: var(--tg-theme-button-color, #2481cc);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        
        .puzzle-piece.empty {
            background: transparent;
            cursor: default;
        }
        
        .puzzle-piece:active:not(.empty) {
            transform: scale(0.95);
        }
        
        .ad-container {
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--tg-theme-secondary-bg-color, #2a3942);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .stat-item {
            background: var(--tg-theme-secondary-bg-color, #2a3942);
            padding: 15px;
            border-radius: 12px;
            flex: 1;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üß© Puzzle Game</h1>
        
        <div class="stats">
            <div class="stat-item">
                <div>Moves</div>
                <div id="moves">0</div>
            </div>
            <div class="stat-item">
                <div>Time</div>
                <div id="timer">0s</div>
            </div>
        </div>
        
        <div class="puzzle-grid" id="puzzleGrid">
            <!-- Puzzle pieces will be generated here -->
        </div>
        
        <!-- Monetag Ad Container -->
        <div class="ad-container">
            <div id="yllix_widget_8f716"></div>
        </div>
        
        <div class="controls">
            <button onclick="showRewardedAd()">üéÅ Get Hint (Watch Ad)</button>
            <button onclick="shufflePuzzle()">üîÄ Shuffle</button>
            <button onclick="newGame()">üÜï New Game</button>
        </div>
        
        <div id="gameMessage"></div>
    </div>

    <script>
        // Game state
        let gameState = {
            moves: 0,
            time: 0,
            timer: null,
            gridSize: 4,
            puzzle: [],
            emptyIndex: 15,
            gameStarted: false,
            hints: 3
        };

        // Initialize Telegram
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // Initialize Monetag
        function initializeMonetag() {
            try {
                // Monetag widget initialization
                if (typeof yllix !== 'undefined') {
                    yllix.createWidget({
                        container: 'yllix_widget_8f716',
                        type: 'banner',
                        width: 300,
                        height: 250
                    });
                    console.log('Monetag banner ad initialized');
                } else {
                    console.warn('Monetag SDK not loaded yet');
                    // Retry after delay
                    setTimeout(initializeMonetag, 1000);
                }
            } catch (error) {
                console.error('Error initializing Monetag:', error);
            }
        }

        // Show rewarded ad
        function showRewardedAd() {
            try {
                if (typeof yllix !== 'undefined') {
                    // Show interstitial ad as rewarded
                    yllix.showInterstitial({
                        onClose: function() {
                            // Reward user after ad is closed
                            gameState.hints += 1;
                            updateGameMessage('üéâ You earned 1 hint! Total hints: ' + gameState.hints);
                            saveGame();
                        },
                        onError: function(error) {
                            updateGameMessage('‚ùå Ad not available. Please try again later.');
                        }
                    });
                } else {
                    // Fallback: simulate ad completion for testing
                    gameState.hints += 1;
                    updateGameMessage('üéâ You earned 1 hint! Total hints: ' + gameState.hints);
                    saveGame();
                }
            } catch (error) {
                console.error('Error showing rewarded ad:', error);
                updateGameMessage('‚ùå Error showing ad. Please try again.');
            }
        }

        // Show interstitial ad
        function showInterstitialAd() {
            try {
                if (typeof yllix !== 'undefined') {
                    yllix.showInterstitial({
                        onClose: function() {
                            console.log('Interstitial ad closed');
                        },
                        onError: function(error) {
                            console.log('Interstitial ad error:', error);
                        }
                    });
                }
            } catch (error) {
                console.error('Error showing interstitial ad:', error);
            }
        }

        // Puzzle game functions
        function initializePuzzle() {
            createPuzzle();
            renderPuzzle();
            startTimer();
            
            // Initialize ads after game starts
            setTimeout(initializeMonetag, 1000);
        }

        function createPuzzle() {
            gameState.puzzle = [];
            for (let i = 1; i <= gameState.gridSize * gameState.gridSize; i++) {
                gameState.puzzle.push(i);
            }
            gameState.puzzle[gameState.puzzle.length - 1] = 0; // Empty space
            gameState.emptyIndex = gameState.puzzle.length - 1;
        }

        function renderPuzzle() {
            const grid = document.getElementById('puzzleGrid');
            grid.innerHTML = '';
            
            gameState.puzzle.forEach((number, index) => {
                const piece = document.createElement('div');
                piece.className = `puzzle-piece ${number === 0 ? 'empty' : ''}`;
                piece.textContent = number === 0 ? '' : number;
                piece.onclick = () => movePiece(index);
                grid.appendChild(piece);
            });
            
            updateDisplay();
        }

        function movePiece(index) {
            if (!isAdjacentToEmpty(index)) return;
            
            // Swap pieces
            [gameState.puzzle[gameState.emptyIndex], gameState.puzzle[index]] = 
            [gameState.puzzle[index], gameState.puzzle[gameState.emptyIndex]];
            
            gameState.emptyIndex = index;
            gameState.moves++;
            
            if (!gameState.gameStarted) {
                gameState.gameStarted = true;
            }
            
            renderPuzzle();
            checkWin();
            saveGame();
        }

        function isAdjacentToEmpty(index) {
            const emptyRow = Math.floor(gameState.emptyIndex / gameState.gridSize);
            const emptyCol = gameState.emptyIndex % gameState.gridSize;
            const pieceRow = Math.floor(index / gameState.gridSize);
            const pieceCol = index % gameState.gridSize;
            
            return (Math.abs(emptyRow - pieceRow) === 1 && emptyCol === pieceCol) ||
                   (Math.abs(emptyCol - pieceCol) === 1 && emptyRow === pieceRow);
        }

        function shufflePuzzle() {
            // Simple shuffle algorithm
            for (let i = 0; i < 1000; i++) {
                const adjacent = [];
                const emptyRow = Math.floor(gameState.emptyIndex / gameState.gridSize);
                const emptyCol = gameState.emptyIndex % gameState.gridSize;
                
                // Find all adjacent pieces
                for (let i = 0; i < gameState.puzzle.length; i++) {
                    if (isAdjacentToEmpty(i)) {
                        adjacent.push(i);
                    }
                }
                
                // Randomly move an adjacent piece
                if (adjacent.length > 0) {
                    const randomIndex = adjacent[Math.floor(Math.random() * adjacent.length)];
                    [gameState.puzzle[gameState.emptyIndex], gameState.puzzle[randomIndex]] = 
                    [gameState.puzzle[randomIndex], gameState.puzzle[gameState.emptyIndex]];
                    gameState.emptyIndex = randomIndex;
                }
            }
            
            gameState.moves = 0;
            gameState.time = 0;
            gameState.gameStarted = false;
            renderPuzzle();
            startTimer();
            saveGame();
            
            // Show interstitial ad after shuffle
            setTimeout(showInterstitialAd, 500);
        }

        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                if (gameState.gameStarted) {
                    gameState.time++;
                    updateDisplay();
                }
            }, 1000);
        }

        function checkWin() {
            for (let i = 0; i < gameState.puzzle.length - 1; i++) {
                if (gameState.puzzle[i] !== i + 1) {
                    return false;
                }
            }
            
            // Puzzle solved!
            clearInterval(gameState.timer);
            updateGameMessage('üéâ Congratulations! You solved the puzzle!');
            
            // Show rewarded ad on completion
            setTimeout(showRewardedAd, 1500);
            
            return true;
        }

        function newGame() {
            clearInterval(gameState.timer);
            gameState.moves = 0;
            gameState.time = 0;
            gameState.gameStarted = false;
            shufflePuzzle();
        }

        function updateDisplay() {
            document.getElementById('moves').textContent = gameState.moves;
            document.getElementById('timer').textContent = gameState.time + 's';
        }

        function updateGameMessage(message) {
            const messageEl = document.getElementById('gameMessage');
            messageEl.textContent = message;
            messageEl.style.color = '#ffd700';
            
            setTimeout(() => {
                messageEl.textContent = '';
            }, 3000);
        }

        // Save/load game state
        function saveGame() {
            localStorage.setItem('puzzleGameSave', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('puzzleGameSave');
            if (saved) {
                const savedState = JSON.parse(saved);
                gameState = { ...gameState, ...savedState };
                renderPuzzle();
                updateDisplay();
                
                if (gameState.gameStarted) {
                    startTimer();
                }
            } else {
                shufflePuzzle();
            }
        }

        // Use hint
        function useHint() {
            if (gameState.hints > 0) {
                gameState.hints--;
                // Simple hint: show valid moves
                const adjacent = [];
                for (let i = 0; i < gameState.puzzle.length; i++) {
                    if (isAdjacentToEmpty(i)) {
                        adjacent.push(i);
                    }
                }
                
                if (adjacent.length > 0) {
                    updateGameMessage('üí° Hint: You can move pieces adjacent to the empty space');
                }
                
                saveGame();
            } else {
                updateGameMessage('‚ùå No hints left! Watch an ad to get more.');
            }
        }

        // Update controls to include hint usage
        document.addEventListener('DOMContentLoaded', function() {
            const controls = document.querySelector('.controls');
            const hintButton = document.createElement('button');
            hintButton.textContent = 'üí° Use Hint (' + gameState.hints + ')';
            hintButton.onclick = useHint;
            controls.insertBefore(hintButton, controls.firstChild);
        });

        // Initialize game when page loads
        window.onload = function() {
            loadGame();
            
            // Set up Telegram Main Button
            Telegram.WebApp.MainButton.setText('Share Game')
                .onClick(() => {
                    Telegram.WebApp.openTelegramLink('https://t.me/your_bot?start=puzzle_game');
                })
                .show();
        };
    </script>
</body>
</html>
